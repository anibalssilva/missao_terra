<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Quiz Miss√£o Terra</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin: 20px; }
    #map { margin: 0 auto; width: 800px; height: 800px; border: 1px solid #ccc; }
    svg { viewBox: 0 0 800 800; width:100%; height:100%; preserveAspectRatio:xMidYMid meet; }
    path { fill:none; stroke:#333; stroke-width:1; stroke-linecap:round; stroke-linejoin:round; shape-rendering:geometricPrecision; }
    #controls { margin-top:15px; }
    #controls select,
    #controls button,
    #controls input { padding:6px 12px; font-size:1em; margin-left:5px; }
    #feedback, #score-display { margin-top:10px; font-weight:bold; font-size: 1.2em; color: green; }
  </style>
</head>
<body>
  <h1>Qual pa√≠s √© este GloboG√™nios?</h1>
  <div id="map"></div>
  <div id="controls">
    <label for="continent-select">Continente:</label>
    <select id="continent-select">
      <option value="Todos">Todos</option>
      <option value="Am√©rica do Sul">Am√©rica do Sul</option>
      <option value="Am√©rica do Norte">Am√©rica do Norte</option>
      <option value="Europa">Europa</option>
      <option value="√Åsia">√Åsia</option>
      <option value="√Åfrica">√Åfrica</option>
      <option value="Oceania">Oceania</option>
    </select>
    <input id="guess" placeholder="Digite o pa√≠s" autocomplete="off" />
    <button id="submit"       type="button">Enviar</button>
    <button id="stop"         type="button">STOP</button>
    <button id="reveal"       type="button">Revelar</button>
    <button id="reveal-score" type="button">Revelar Acertos</button>
    <button id="new-map"      type="button" disabled>Novo Mapa</button>
    <div id="feedback"></div>
    <div id="score-display"></div>
  </div>

  <script>
    const width = 800, height = 800;
    const svg = d3.select('#map').append('svg')
      .attr('viewBox', `0 0 ${width} ${height}`);

    const projection = d3.geoMercator().scale(1).translate([0,0]);
    const path = d3.geoPath().projection(projection);

    let worldData, 
        countryByContinent = {}, 
        remaining = [], 
        currentCountry, currentPath, attempts, correctCount = 0;

    // tradu√ß√µes dos continentes do GeoJSON (ingl√™s ‚Üí portugu√™s)
    const contMap = {
      "South America": "Am√©rica do Sul",
      "North America": "Am√©rica do Norte",
      "Europe":         "Europa",
      "Asia":           "√Åsia",
      "Africa":         "√Åfrica",
      "Oceania":        "Oceania",
      // se houver Ant√°rtica, etc.
    };

    function normalize(str) {
      return str.normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase();
    }
    function getGeoName(f) {
      return f.properties.NAME ||
             f.properties.name ||
             f.properties.ADMIN ||
             f.properties.ADMIN_PT ||
             '';
    }
    function getGeoContinent(f) {
      // assume f.properties.CONTINENT em ingl√™s
      const eng = f.properties.CONTINENT;
      return contMap[eng] || "Outro";
    }

    d3.json('world_ptbr_filtrado.geojson').then(data => {
      worldData = data;
      // Monta countryByContinent
      countryByContinent = { "Todos": [] };
      worldData.features.forEach(f => {
        const nome = getGeoName(f);
        const cont = getGeoContinent(f);
        // adiciona em Todos
        countryByContinent["Todos"].push(nome);
        // adiciona em seu continente
        if (!countryByContinent[cont]) countryByContinent[cont] = [];
        countryByContinent[cont].push(nome);
      });

      initQuiz();
    });

    function initQuiz() {
      document.getElementById('submit').addEventListener('click', handleGuess);
      document.getElementById('stop').addEventListener('click', stopAnimation);
      document.getElementById('reveal').addEventListener('click', revealAnswer);
      document.getElementById('reveal-score').addEventListener('click', showScore);
      document.getElementById('new-map').addEventListener('click', startQuiz);
      document.getElementById('continent-select').addEventListener('change', () => {
        // ao mudar continente, zera placar e recome√ßa
        correctCount = 0;
        document.getElementById('score-display').textContent = '';
        startQuiz();
      });
      startQuiz();
    }

    function startQuiz() {
      projection.scale(1).translate([0,0]);
      if (currentPath) currentPath.remove();
      attempts = 0;
      document.getElementById('guess').value = '';
      document.getElementById('feedback').textContent = '';
      document.getElementById('reveal-score').disabled = false;
      ['submit','stop','reveal','reveal-score'].forEach(id => document.getElementById(id).disabled = false);
      document.getElementById('new-map').disabled = true;

      const cont = document.getElementById('continent-select').value;
      const pool = countryByContinent[cont] || [];
      if (pool.length === 0) {
        document.getElementById('feedback').textContent = `Nenhum pa√≠s em "${cont}".`;
        return;
      }
      // repopula remaining se vazio
      if (remaining.length === 0 || !remainingPool || remainingPoolCont !== cont) {
        remaining = pool.slice();
        remainingPoolCont = cont;
      }
      // escolhe aleat√≥rio
      const idx = Math.floor(Math.random() * remaining.length);
      currentCountry = remaining.splice(idx,1)[0];

      const feat = worldData.features.find(f => normalize(getGeoName(f)) === normalize(currentCountry));
      if (!feat) {
        console.error('N√£o encontrado:', currentCountry);
        return startQuiz();
      }
      zoomFeature(feat);
      currentPath = svg.append('path').datum(feat).attr('d', path);

      const total = currentPath.node().getTotalLength();
      currentPath
        .attr('stroke-dasharray', `${total} ${total}`)
        .attr('stroke-dashoffset', total)
        .transition().duration(30000).ease(d3.easeLinear)
        .attr('stroke-dashoffset', 0);
    }

    function zoomFeature(feature) {
      const b = path.bounds(feature);
      const dx = b[1][0]-b[0][0], dy = b[1][1]-b[0][1];
      const x = (b[0][0]+b[1][0])/2, y = (b[0][1]+b[1][1])/2;
      const scaleVal = Math.min(width/dx, height/dy)*0.9;
      projection.scale(scaleVal)
                .translate([width/2 - scaleVal*x, height/2 - scaleVal*y]);
    }

    function stopAnimation() {
      if (currentPath) currentPath.interrupt();
      document.getElementById('stop').disabled = true;
    }

    function handleGuess() {
      const input = document.getElementById('guess').value.trim();
      if (!input) return;
      attempts++;
      if (normalize(input) === normalize(currentCountry)) {
        correctCount++;
        document.getElementById('feedback').textContent = `‚úîÔ∏è Correto! √â ${currentCountry}.`;
        prepareNext();
      } else if (attempts >= 3) {
        document.getElementById('feedback').textContent = `‚ùå Errou 3 vezes. Era: ${currentCountry}.`;
        prepareNext();
      } else {
        document.getElementById('feedback').textContent = `‚ùå Errado (${attempts}/3).`;
      }
    }

    function revealAnswer() {
      if (currentPath) currentPath.interrupt().attr('stroke-dashoffset', 0);
      document.getElementById('feedback').textContent = `üîç Era: ${currentCountry}.`;
      prepareNext();
    }

    function showScore() {
      document.getElementById('score-display').textContent = `üåü Acertos: ${correctCount}`;
      document.getElementById('reveal-score').disabled = true;
    }

    function prepareNext() {
      ['submit','stop','reveal'].forEach(id => document.getElementById(id).disabled = true);
      document.getElementById('new-map').disabled = false;
      document.getElementById('new-map').focus();
    }
  </script>
</body>
</html>
