<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Quiz Miss√£o Terra</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin: 20px; }
    #map { margin: 0 auto; width: 800px; height: 800px; border: 1px solid #ccc; }
    svg { viewBox: 0 0 800 800; width:100%; height:100%; preserveAspectRatio:xMidYMid meet; }
    path { fill:none; stroke:#333; stroke-width:1; stroke-linecap:round; stroke-linejoin:round; shape-rendering:geometricPrecision; }
    #controls { margin-top:15px; }
    #controls select,
    #controls button,
    #controls input { padding:6px 12px; font-size:1em; margin-left:5px; }
    #feedback, #score-display { margin-top:10px; font-weight:bold; font-size: 1.2em; color: green; }
  </style>
</head>
<body>
  <h1>Qual pa√≠s √© este GloboG√™nios?</h1>
  <div id="map"></div>
  <div id="controls">
    <label for="continent-select">Continente:</label>
    <select id="continent-select">
      <option value="Todos">Todos</option>
      <option value="Am√©rica do Sul">Am√©rica do Sul</option>
      <option value="Am√©rica do Norte">Am√©rica do Norte</option>
      <option value="Europa">Europa</option>
      <option value="√Åsia">√Åsia</option>
      <option value="√Åfrica">√Åfrica</option>
      <option value="Oceania">Oceania</option>
    </select>
    <input id="guess" placeholder="Digite o pa√≠s" autocomplete="off" />
    <button id="submit"       type="button">Enviar</button>
    <button id="stop"         type="button">STOP</button>
    <button id="reveal"       type="button">Revelar</button>
    <button id="reveal-score" type="button">Revelar Acertos</button>
    <button id="new-map"      type="button" disabled>Novo Mapa</button>
    <div id="feedback"></div>
    <div id="score-display"></div>
  </div>

  <script>
    const width = 800, height = 800;
    const svg = d3.select('#map').append('svg')
      .attr('viewBox', `0 0 ${width} ${height}`)
      .attr('width', width)
      .attr('height', height);

    const projection = d3.geoMercator().scale(1).translate([0,0]);
    const path = d3.geoPath().projection(projection);

    let worldData,
        countryByContinent = {},
        remaining = [],
        remainingPoolCont = null,
        currentCountry, currentPath, attempts, correctCount = 0;

    // Mapa completo pa√≠s ‚Üí continente
    const countryContinentMap = {
      "GUATEMALA": "Am√©rica do Norte", "ISL√ÇNDIA": "Europa", "EL SALVADOR": "Am√©rica do Norte",
      "M√âXICO": "Am√©rica do Norte", "HONDURAS": "Am√©rica do Norte", "CANAD√Å": "Am√©rica do Norte",
      "COSTA RICA": "Am√©rica do Norte", "ALASCA": "Am√©rica do Norte", "BELIZE": "Am√©rica do Norte",
      "ESTADOS UNIDOS DA AM√âRICA": "Am√©rica do Norte", "PANAM√Å": "Am√©rica do Norte", "GROENL√ÇNDIA": "Am√©rica do Norte",
      "ILHAS HAVA√ç": "Am√©rica do Norte", "NICAR√ÅGUA": "Am√©rica do Norte", "BAHAMAS": "Am√©rica do Norte",
      "CUBA": "Am√©rica do Norte", "ILHAS CAYMAN": "Am√©rica do Norte", "JAMAICA": "Am√©rica do Norte",
      "HAITI": "Am√©rica do Norte", "ILHAS TURKS E CAICOS": "Am√©rica do Norte", "PORTO RICO": "Am√©rica do Norte",
      "REP√öBLICA DOMINICANA": "Am√©rica do Norte", "ILHAS VIRGENS (REINO UNIDO)": "Am√©rica do Norte",
      "ILHAS VIRGENS (ESTADOS UNIDOS)": "Am√©rica do Norte", "S√ÉO CRISTOV√ÉO E NEVIS": "Am√©rica do Norte",
      "BARBUDA": "Am√©rica do Norte", "MONTSERRAT": "Am√©rica do Norte", "ANGUILLA (REINO UNIDO)": "Am√©rica do Norte",
      "MARTINICA": "Am√©rica do Norte", "DOMINICA": "Am√©rica do Norte", "BARBADOS": "Am√©rica do Norte",
      "GRANADA": "Am√©rica do Norte", "SANTA L√öCIA": "Am√©rica do Norte", "S√ÉO VICENTE & GRANADINAS": "Am√©rica do Norte",
      "TRINIDAD E TOBAGO": "Am√©rica do Norte", "VENEZUELA": "Am√©rica do Sul", "GUIANA": "Am√©rica do Sul",
      "SURINAME": "Am√©rica do Sul", "GUIANA FRANCESA": "Am√©rica do Sul", "PERU": "Am√©rica do Sul",
      "ARGENTINA": "Am√©rica do Sul", "COL√îMBIA": "Am√©rica do Sul", "ILHAS GAL√ÅPAGOS (EQUADOR)": "Am√©rica do Sul",
      "URUGUAI": "Am√©rica do Sul", "BRASIL": "Am√©rica do Sul", "CHILE": "Am√©rica do Sul",
      "BOLIVIA": "Am√©rica do Sul", "PARAGUAI": "Am√©rica do Sul", "ILHAS MALVINAS (ARGENTINA)": "Am√©rica do Sul",
      "ILHA GE√ìRGIA DO SUL (REINO UNIDO)": "Am√©rica do Sul", "ESTONIA": "Europa", "GR√âCIA": "Europa",
      "LET√îNIA": "Europa", "ALB√ÇNIA": "Europa", "BELARUS": "Europa", "MONTENEGRO": "Europa",
      "UCR√ÇNIA": "Europa", "S√âRVIA": "Europa", "MOLD√ÅVIA": "Europa", "CRO√ÅCIA": "Europa",
      "ROM√äNIA": "Europa", "B√ìSNIA HEZERGOV√çNIA": "Europa", "TURQUIA": "Europa", "ESLOV√äNIA": "Europa",
      "BULG√ÅRIA": "Europa", "HUNGRIA": "Europa", "MACED√îNIA": "Europa", "ESLOVAQUIA": "Europa",
      "POL√îNIA": "Europa", "LUXEMBURGO": "Europa", "LIECHTENSTEIN": "Europa", "NORUEGA": "Europa",
      "√ÅUSTRIA": "Europa", "SU√ç√áA": "Europa", "HOLANDA": "Europa", "SU√âCIA": "Europa",
      "B√âLGICA": "Europa", "FINL√ÇNDIA": "Europa", "IT√ÅLIA": "Europa", "DINAMARCA": "Europa",
      "FRAN√áA": "Europa", "ALEMANHA": "Europa", "ESPANHA": "Europa", "INGLATERRA": "Europa",
      "REINO UNIDO": "Europa", "IRLANDA DO NORTE": "Europa", "IRLANDA DO SUL": "Europa",
      "PORTUGAL": "Europa", "ESC√ìCIA": "Europa", "PA√çS DE GALES": "Europa", "ILHAS MADEIRA": "Europa",
      "MAURIT√ÇNIA": "√Åfrica", "ILHAS CAN√ÅRIAS": "Europa", "MARROCOS": "√Åfrica", "MALI": "√Åfrica",
      "CABO VERDE": "√Åfrica", "N√çGER": "√Åfrica", "ARG√âLIA": "√Åfrica", "CHADE": "√Åfrica",
      "SUD√ÉO": "√Åfrica", "TUN√çSIA": "√Åfrica", "ERITR√âIA": "√Åfrica", "EGITO": "√Åfrica",
      "DJIBUTI": "√Åfrica", "SAARA OCIDENTAL": "√Åfrica", "SENEGAL": "√Åfrica", "G√ÇMBIA": "√Åfrica",
      "NIG√âRIA": "√Åfrica", "GUIN√â BISSAU": "√Åfrica", "CAMAR√ïES": "√Åfrica", "SERRA LEOA": "√Åfrica",
      "REP√öBLICA CENTRO-AFRICANA": "√Åfrica", "BURKINA FASO": "√Åfrica", "SUD√ÉO DO SUL": "√Åfrica",
      "COSTA DO MARFIM": "√Åfrica", "ETI√ìPIA": "√Åfrica", "GANA": "√Åfrica", "LIB√âRIA": "√Åfrica",
      "SOM√ÅLIA": "√Åfrica", "TOGO": "√Åfrica", "GUIN√â EQUATORIAL": "√Åfrica", "BEIN": "√Åfrica",
      "S√ÉO TOM√â & PR√çNCIPE": "√Åfrica", "√ÅRFICA DO SUL": "√Åfrica", "MALAU√ç": "√Åfrica", "GAB√ÉO": "√Åfrica",
      "MO√áAMBIQUE": "√Åfrica", "CONGO": "√Åfrica", "SEICHELES": "√Åfrica", "REPUBLICA DEMOCR√ÅTICA DO CONGO": "√Åfrica",
      "MADGASCAR": "√Åfrica", "RUANDA": "√Åfrica", "COMORES": "√Åfrica", "BURUNDI": "√Åfrica",
      "NAM√çBIA": "√Åfrica", "QU√äNIA": "√Åfrica", "MAUR√çCIO": "√Åfrica", "LESOTO": "√Åfrica",
      "TANZ√ÇNIA": "√Åfrica", "SUAZIL√ÇNDIA": "√Åfrica", "Z√ÇMBIA": "√Åfrica", "ZIMB√ÅBUE": "√Åfrica",
      "ANGOLA": "√Åfrica", "BOTSUANA": "√Åfrica", "R√öSSIA": "Europa", "AFEGANIST√ÉO": "√Åsia",
      "MONG√ìLIA": "√Åsia", "CAMBOJA": "√Åsia", "CHINA": "√Åsia", "VIETN√É": "√Åsia",
      "CAZAQUIST√ÉO": "√Åsia", "UZBEQUIST√ÉO": "√Åsia", "GE√ìRGIA": "√Åsia", "QUIRGUIST√ÉO": "√Åsia",
      "ARM√äNIA": "√Åsia", "IRAQUE": "√Åsia", "MALDIVAS": "√Åsia", "TURCOMENIST√ÉO": "√Åsia",
      "S√çRIA": "√Åsia", "TADJIQUIST√ÉO": "√Åsia", "AZERBAIJ√ÉO": "√Åsia", "PAQUIST√ÉO": "√Åsia"
      // continue adicionando os remanescentes conforme necess√°rio...
    };

    function normalize(str) {
      return str.normalize('NFD').replace(/[ÃÄ-\u036f]/g, '').toLowerCase();
    }
    function getGeoName(f) {
      return f.properties.NAME || f.properties.name || f.properties.ADMIN || f.properties.ADMIN_PT || '';
    }

    d3.json('world_ptbr_filtered.geojson').then(data => {
      worldData = data;
      countryByContinent = { 'Todos': [] };
      data.features.forEach(f => {
        const nome = getGeoName(f).trim();
        const key = nome.toUpperCase();
        const cont = countryContinentMap[key] || 'Outro';
        if (!countryByContinent[cont]) countryByContinent[cont] = [];
        countryByContinent[cont].push(nome);
        countryByContinent['Todos'].push(nome);
      });
      initQuiz();
    });

    function initQuiz() {
      ['submit','stop','reveal','reveal-score','new-map','continent-select'].forEach(id => {
        document.getElementById(id === 'continent-select' ? 'continent-select' : id)
          .addEventListener(id === 'continent-select' ? 'change' : 'click', () => {
            if (id === 'continent-select') correctCount = 0, document.getElementById('score-display').textContent = '';
            startQuiz();
          });
      });
      startQuiz();
    }

    function startQuiz() {
      projection.scale(1).translate([0,0]);
      if (currentPath) currentPath.remove();
      attempts = 0;
      document.getElementById('guess').value = '';
      document.getElementById('feedback').textContent = '';
      ['submit','stop','reveal','reveal-score'].forEach(id => document.getElementById(id).disabled = false);
      document.getElementById('new-map').disabled = true;

      const cont = document.getElementById('continent-select').value;
      const pool = countryByContinent[cont] || [];
      if (!pool.length) {
        document.getElementById('feedback').textContent = `Nenhum pa√≠s em "${cont}".`;
        return;
      }
      if (remainingPoolCont !== cont || !remaining.length) {
        remaining = pool.slice(); remainingPoolCont = cont;
      }
      const idx = Math.floor(Math.random() * remaining.length);
      currentCountry = remaining.splice(idx,1)[0];

      const feat = worldData.features.find(f => normalize(getGeoName(f)) === normalize(currentCountry));
      if (!feat) return startQuiz();
      const b = path.bounds(feat);
      const dx = b[1][0]-b[0][0], dy = b[1][1]-b[0][1];
      const x = (b[0][0]+b[1][0])/2, y = (b[0][1]+b[1][1])/2;
      const scaleVal = Math.min(width/dx, height/dy)*0.8;
      projection.scale(scaleVal).translate([width/2 - scaleVal*x, height/2 - scaleVal*y]);
      currentPath = svg.append('path').datum(feat).attr('d', path);

      const total = currentPath.node().getTotalLength();
      currentPath.attr('stroke-dasharray', `${total} ${total}`)
                 .attr('stroke-dashoffset', total)
                 .transition().duration(30000).ease(d3.easeLinear)
                 .attr('stroke-dashoffset', 0);
    }

    document.getElementById('submit').addEventListener('click', () => {
      attempts++;
      const input = document.getElementById('guess').value.trim();
      if (!input) return;
      if (normalize(input) === normalize(currentCountry)) {
        correctCount++;
        document.getElementById('feedback').textContent = `‚úîÔ∏è Correto! √â ${currentCountry}.`;
        prepareNext();
      } else if (attempts >= 3) {
        document.getElementById('feedback').textContent = `‚ùå Errou 3 vezes. Era: ${currentCountry}.`;
        prepareNext();
      } else {
        document.getElementById('feedback').textContent = `‚ùå Errado (${attempts}/3).`;
      }
    });

    document.getElementById('stop').addEventListener('click', () => {
      if (currentPath) currentPath.interrupt();
      document.getElementById('stop').disabled = true;
    });

    document.getElementById('reveal').addEventListener('click', () => {
      if (currentPath) currentPath.interrupt().attr('stroke-dashoffset', 0);
      document.getElementById('feedback').textContent = `üîç Era: ${currentCountry}.`;
      prepareNext();
    });

    document.getElementById('reveal-score').addEventListener('click', () => {
      document.getElementById('score-display').textContent = `üåü Acertos: ${correctCount}`;
      document.getElementById('reveal-score').disabled = true;
    });

    function prepareNext() {
      ['submit','stop','reveal'].forEach(id => document.getElementById(id).disabled = true);
      document.getElementById('new-map').disabled = false;
      document.getElementById('new-map').focus();
    }
  </script>
</body>
</html>
