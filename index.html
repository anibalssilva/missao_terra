<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Quiz de Contorno de Pa√≠ses</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin: 20px; }
    #map { margin: 0 auto; width: 800px; height: 800px; border: 1px solid #ccc; }
    svg { viewBox: 0 0 800 800; width:100%; height:100%; preserveAspectRatio:xMidYMid meet; }
    path { fill:none; stroke:#333; stroke-width:1; stroke-linecap:round; stroke-linejoin:round; shape-rendering:geometricPrecision; }
    #controls { margin-top:15px; }
    #controls button, #controls input { padding:6px 12px; font-size:1em; margin-left:5px; }
    #feedback, #score-display { margin-top:10px; font-weight:bold; }
  </style>
</head>
<body>
  <h1>Qual pa√≠s √© este?</h1>
  <div id="map"></div>
  <div id="controls">
    <input id="guess" placeholder="Digite o pa√≠s" autocomplete="off" />
    <button id="submit"    type="button">Enviar</button>
    <button id="stop"      type="button">STOP</button>
    <button id="reveal"    type="button">Revelar</button>
    <button id="reveal-score" type="button">Revelar Acertos</button>
    <button id="new-map"   type="button" disabled>Novo Mapa</button>
    <div id="feedback"></div>
    <div id="score-display"></div>
  </div>

  <script>
    const width = 800, height = 800;
    const svg = d3.select('#map').append('svg')
      .attr('viewBox', `0 0 ${width} ${height}`)
      .attr('width', width)
      .attr('height', height);

    // Projection e path globais
    const projection = d3.geoMercator().scale(1).translate([0,0]);
    const path = d3.geoPath().projection(projection);

    // Lista completa de pa√≠ses
    const allCountries = [
      "Afeganist√£o", "Akrotiri Sovereign Base Area", "Alb√¢nia", "Alemanha", "Andorra", "Angola",
      "Anguila", "Ant√°rtida", "Ant√≠gua e Barbuda", "Argentina", "Arg√©lia", "Arm√™nia",
      "Aruba", "Ar√°bia Saudita", "Ashmore and Cartier Islands", "Austr√°lia", "√Åustria", "Azerbaij√£o",
      "Bahamas", "Bahrain", "Bangladesh", "Barbados", "B√©lgica", "Belize",
      "Benim", "Bermudas", "Bielorr√∫ssia", "Bol√≠via", "B√≥snia e Herzegovina", "Botswana",
      "Brasil", "Brunei", "Bulg√°ria", "Burquina Faso", "Burundi", "But√£o",
      "Cabo Verde", "Camar√µes", "Camboja", "Canad√°", "Catar", "Cazaquist√£o",
      "Chade", "Chile", "China", "Chipre", "Col√¥mbia", "Comores",
      "Congo (Brazzaville)", "Congo (Kinshasa)", "Cook Islands", "Cor√©ia do Sul", "Cor√©ia do Norte", "Costa do Marfim",
      "Costa Rica", "Cro√°cia", "Cuba", "Dinamarca", "Djibuti", "Dominica",
      "Egito", "El Salvador", "Emirados √Årabes Unidos", "Equador", "Eritreia", "Eslov√°quia",
      "Eslov√™nia", "Espanha", "Estados Unidos da Am√©rica", "Est√¥nia", "Eti√≥pia", "Fiji",
      "Filipinas", "Finl√¢ndia", "Fran√ßa", "Gab√£o", "G√¢mbia", "Gana",
      "Ge√≥rgia", "Gibraltar", "Granada", "Gr√©cia", "Groenl√¢ndia", "Guadalupe",
      "Guam", "Guatemala", "Guernsey", "Guiana", "Guiana Francesa", "Haiti",
      "Honduras", "Hong Kong", "Hungria", "Ilha Bouvet", "Ilha Christmas", "Ilha Heard e Ilhas McDonald",
      "Ilhas Caim√£o", "Ilhas Cook", "Ilhas Feroe", "Ilhas Malvinas", "Ilhas Marshall", "Ilhas Menores Distantes dos EUA",
      "Ilhas Salom√£o", "Ilhas Virgens Americanas", "Ilhas Virgens Brit√¢nicas", "Ilhas Wallis e Futuna", "√çndia", "Indon√©sia",
      "Ir√£", "Iraque", "Irlanda", "Isl√¢ndia", "Israel", "It√°lia",
      "Jamaica", "Jap√£o", "Jersey", "Jord√¢nia", "Kiribati", "Kuwait",
      "Laos", "Lesoto", "Let√¥nia", "L√≠bano", "Lib√©ria", "L√≠bia",
      "Listenstaine", "Litu√¢nia", "Luxemburgo", "Macau", "Maced√¥nia do Norte", "Madagascar",
      "Mal√°sia", "Malaui", "Maldivas", "Mali", "Malta", "Marrocos",
      "Martinica", "Maur√≠cio", "Maurit√¢nia", "Mayotte", "M√©xico", "Micron√©sia",
      "Mo√ßambique", "Mold√°via", "M√¥naco", "Montenegro", "Montserrat", "Myanmar",
      "Nam√≠bia", "Nauru", "Nepal", "Nicar√°gua", "N√≠ger", "Nig√©ria",
      "Niue", "Noruega", "Nova Caled√¥nia", "Nova Zel√¢ndia", "Om√£", "Palau",
      "Panam√°", "Papua Nova Guin√©", "Paquist√£o", "Paraguai", "Peru", "Pitcairn",
      "Pol√¥nia", "Porto Rico", "Portugal", "Qu√™nia", "Quirguist√£o", "Reino Unido",
      "Rep√∫blica Centro-Africana", "Rep√∫blica Dominicana", "Rep√∫blica Tcheca", "Rom√™nia", "Ruanda", "R√∫ssia",
      "Saara Ocidental", "Saint Martin", "Saint-Pierre e Miquelon", "Samoa", "Saudita, Ar√°bia", "Senegal",
      "Serra Leoa", "S√©rvia", "Seychelles", "Singapura", "Sint Maarten", "S√≠ria",
      "Som√°lia", "Sri Lanka", "Suazil√¢ndia", "Sud√£o", "Sud√£o do Sul", "Su√©cia",
      "Su√≠√ßa", "Suriname", "Tadjiquist√£o", "Tail√¢ndia", "Taiwan", "Tanz√¢nia",
      "Territ√≥rio Brit√¢nico do Oceano √çndico", "Territ√≥rios Australianos do Sul", "Timor-Leste", "Togo", "Tokelau", "Tonga",
      "Trindade e Tobago", "Trist√£o da Cunha", "Tun√≠sia", "Turcas e Caicos", "Turquemenist√£o", "Turquia",
      "Tuvalu", "Ucr√¢nia", "Uganda", "Uruguai", "US Naval Base Guantanamo Bay", "Uzbequist√£o",
      "Vanuatu", "Venezuela", "Vietn√£", "Z√¢mbia", "Zimb√°bue"

    ];
    let remaining = [...allCountries];
    let currentCountry, currentPath, attempts, correctCount = 0;
    let worldData = null;

    // Normaliza√ß√£o de texto
    function normalize(str) {
      return str.normalize('NFD').replace(/[ÃÄ-\u036f]/g, '').toLowerCase();
    }
    // Fun√ß√£o para obter nome no GeoJSON
    function getGeoName(f) {
      return f.properties.NAME || f.properties.name || f.properties.ADMIN || f.properties.ADMIN_PT || '';
    }

    // Calcula zoom e centro para a feature
    function zoomFeature(feature) {
      const b = path.bounds(feature);
      const dx = b[1][0] - b[0][0], dy = b[1][1] - b[0][1];
      const x = (b[0][0] + b[1][0]) / 2, y = (b[0][1] + b[1][1]) / 2;
      const scaleVal = Math.min(width / dx, height / dy) * 0.9;
      const translate = [width / 2 - scaleVal * x, height / 2 - scaleVal * y];
      projection.scale(scaleVal).translate(translate);
    }

    // Carrega GeoJSON e inicializa
    d3.json('world_ptbr.geojson').then(data => {
      worldData = data;
      initQuiz();
    });

    function initQuiz() {
      document.getElementById('submit').addEventListener('click', handleGuess);
      document.getElementById('stop').addEventListener('click', stopAnimation);
      document.getElementById('reveal').addEventListener('click', revealAnswer);
      document.getElementById('reveal-score').addEventListener('click', showScore);
      document.getElementById('new-map').addEventListener('click', startQuiz);
      startQuiz();
    }

    function startQuiz() {
      // Reset de proje√ß√£o para novo mapa
      projection.scale(1).translate([0,0]);

      // Limpa path anterior se existir
      if (currentPath) {
        currentPath.remove();
        currentPath = null;
      }

      // Reset de estado
      attempts = 0;
      document.getElementById('guess').value = '';
      document.getElementById('feedback').textContent = '';
      document.getElementById('score-display').textContent = '';
      ['submit','stop','reveal','reveal-score'].forEach(id => document.getElementById(id).disabled = false);
      document.getElementById('new-map').disabled = true;

      if (!worldData) return;
      if (remaining.length === 0) remaining = [...allCountries];
      const idx = Math.floor(Math.random() * remaining.length);
      currentCountry = remaining.splice(idx,1)[0];

      // Encontra feature correspondente
      const feat = worldData.features.find(f => normalize(getGeoName(f)) === normalize(currentCountry));
      if (!feat) {
        console.error('Pa√≠s n√£o encontrado no GeoJSON:', currentCountry);
        return startQuiz();
      }

      // Aplica zoom e desenha
      zoomFeature(feat);
      currentPath = svg.append('path').datum(feat).attr('d', path);

      const total = currentPath.node().getTotalLength();
      currentPath
        .attr('stroke-dasharray', `${total} ${total}`)
        .attr('stroke-dashoffset', total)
        .transition().duration(30000).ease(d3.easeLinear)
        .attr('stroke-dashoffset', 0);
    }

    function stopAnimation() {
      if (currentPath) currentPath.interrupt();
      document.getElementById('stop').disabled = true;
    }

    function handleGuess() {
      const input = document.getElementById('guess').value.trim();
      if (!input) return;
      attempts++;
      if (normalize(input) === normalize(currentCountry)) {
        correctCount++;
        document.getElementById('feedback').textContent = `‚úîÔ∏è Correto! √â ${currentCountry}.`;
        prepareNext();
      } else if (attempts >= 3) {
        document.getElementById('feedback').textContent = `‚ùå Errou 3 vezes. Era: ${currentCountry}.`;
        prepareNext();
      } else {
        document.getElementById('feedback').textContent = `‚ùå Errado (${attempts}/3).`;
      }
    }

    function revealAnswer() {
      if (currentPath) currentPath.interrupt().attr('stroke-dashoffset', 0);
      document.getElementById('feedback').textContent = `üîç Era: ${currentCountry}.`;
      prepareNext();
    }

    function showScore() {
      document.getElementById('score-display').textContent = `üåü Acertos: ${correctCount}`;
      document.getElementById('reveal-score').disabled = true;
    }

    function prepareNext() {
      ['submit','stop','reveal'].forEach(id => document.getElementById(id).disabled = true);
      document.getElementById('new-map').disabled = false;
      document.getElementById('new-map').focus();
    }
  </script>
</body>
</html>
